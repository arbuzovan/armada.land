(function(){tinymce.PluginManager.requireLangPack("imagemanager");tinymce.create("tinymce.plugins.ImageManagerPlugin",{init:function(a,b){this.editor=a;this.url=b;var c=new ImageManagerPanel(a);a.addCommand("umiToggleImageManager",function(){var d=c.toggle();a.controlManager.setActive("imagemanager",d)});a.addButton("imagemanager",{title:"imagemanager.toggle_btn",cmd:"umiToggleImageManager"});jQuery("head").append('<link rel="stylesheet" type="text/css" href="'+b+'/css/imagemanager.css" />')},createControl:function(b,a){return null},getInfo:function(){return{longname:"Image manager plugin",author:"Leeb, Realloc",authorurl:"http://umi-cms.ru/",infourl:"http://umi-cms.ru/",version:"2.0"}}});tinymce.PluginManager.add("imagemanager",tinymce.plugins.ImageManagerPlugin)})();function ImageManagerPanel(l){var m=this;var f=l;var a=null;var d=false;var b=null;var h=0;var c=function(){};var k=function(){var p=f.getContainer();a=jQuery('<div class="imanager"></div>');a.css({display:"none"});a.prependTo(p);b=new ImageManagerPath({selectCallback:i,container:a.get(0)});a.append('<div class="container">						<a class="scroll-right"></a>						<a class="scroll-left"></a>						<div class="wrapper" id="mce_editor_0_wrap">							<ul class="igallery"></ul>							<div class="del" style="left:105px; top:14px; display:none;"></div>						</div>						<div class="add-image"></div>					  </div>					  <div class="upload_image" style="display:none;">						<form method="post" enctype="multipart/form-data" target="'+f.id+'imgmgr_upload">						<div class="button">							<input type="submit" value="'+f.getLang("imagemanager.lbl_upload")+'" />							<span class="l"></span>							<span class="r"></span>						</div>						<label for="upload-image">'+f.getLang("imagemanager.lbl_upload_image")+'							<input type="file" name="Filedata" />						</label>						</form>						<iframe id="'+f.id+'imgmgr_upload" name="'+f.id+'imgmgr_upload" style="display:none" />					 </div>');var t=jQuery("div.wrapper",a);var r=0;var o=null;var n=function(){if(Math.abs(h)<30){h=h+r*2}t.scrollLeft(t.scrollLeft()+h);if(h==0){clearInterval(o)}if(r==0){if(h>0){h=Math.floor(h*0.8)}else{h=Math.ceil(h*0.8)}}};jQuery("a.scroll-left",a).mouseenter(function(){o=setInterval(n,50);r=-1}).mouseleave(function(){r=0});jQuery("a.scroll-right",a).mouseenter(function(){o=setInterval(n,50);r=1}).mouseleave(function(){r=0});jQuery("div.del",a).click(function(){var u=this.panelItem;f.windowManager.confirm(f.getLang("imagemanager.lbl_remove_img_title"),function(v){if(v){j(u)}});jQuery(this).hide()}).mouseover(function(){jQuery(this).show()}).mouseleave(function(){jQuery(this).hide()});jQuery("form",a).submit(function(){jQuery("iframe#"+f.id+"imgmgr_upload",a).one("load",{},function(){var v=jQuery("div.wrapper ul",a);var w=jQuery("udata",this.contentDocument).attr("folder")+"/";var u=jQuery("file",this.contentDocument);if(u.size()){g(u,w,v,true)}else{f.windowManager.alert(f.getLang("imagemanager.lbl_upload_error"))}jQuery("form input[type=submit]",a).attr("disabled",false)});jQuery(this).attr("action","/admin/data/uploadfile/?csrf="+csrfProtection.getToken()+"&imagesOnly&folder="+base64encode(b.getPath()));jQuery("input[type=submit]",this).attr("disabled",true)});var s=jQuery("div.add-image",a);s.click(function(){jQuery("div.upload_image",a).toggle();jQuery(this).toggleClass("off")});if(jQuery.browser.msie&&(jQuery.browser.version=="7.0"||document.documentMode<7)){s.css({top:"120px",padding:"5px 0"})}m.loadFolder("/images");var q=jQuery("div.wrapper ul",a)};var i=function(n){m.loadFolder(n)};this.loadFolder=function(n){jQuery.get("/admin/data/getfilelist/",{folder:base64encode(n),showOnlyImages:true,rrr:Math.random()},e)};var j=function(n){var o=jQuery("img",n).get(0).information;n.remove();jQuery.get("/admin/data/deletefiles/",{folder:base64encode(o.img_path.substr(0,o.img_path.length-1)),"delete[]":base64encode(o.img_name),nolisting:true})};var g=function(r,z,u,s){var o=r.attr("name");var v=o.substr(0,o.lastIndexOf("."));var w=r.attr("type");var n="/autothumbs.php?img="+z+v+"_sl_90_60."+w;var p=r.attr("width");var x=r.attr("height");var y=jQuery('<li class="image">						<img class="panel_item" title="'+f.getLang("imagemanager.lbl_move_help")+'" src="'+n+'"/>						<div class="name" title="'+r.attr("mime")+", "+p+"x"+x+"px, "+r.attr("converted-size")+'">'+o+"</div>					  </li>");var q={img_name:o,img_path:z,img_src:n,img_width:90,img_height:60,img_base:"/autothumbs.php?img="+z+v,img_ext:w,orig_src:z+o,orig_width:p,orig_height:x};jQuery("img",y).get(0).information=q;u.append(y);if(jQuery.browser.msie&&(jQuery.browser.version=="7.0"||document.documentMode<8)){var t=jQuery(".name",y).width();jQuery(y).css({padding:((t<92)?"10px 5px":"10px "+(((t-92)+10)/2)+"px")});jQuery(".name",y).css({width:((t<102)?102:t+12)})}if(s){jQuery("img",y).mouseenter(function(){if(h!==0){return}var C=jQuery("div.del",a);var A=jQuery(this).offset();var D=A.left+43;if(D<C.parent().width()){C.css({left:D});if(jQuery.browser.msie&&(jQuery.browser.version=="7.0"||document.documentMode<8)){var B=A.left+23;if(jQuery.browser.version=="7.0"||document.documentMode<7){var E=Math.abs(u.offset().left-57);B=B+E}C.css({left:B,top:0})}C.get(0).panelItem=jQuery(this).parent();C.show()}}).mouseleave(function(){jQuery("div.del",a).hide()}).draggable({helper:"clone",revert:"invalid"}).disableSelection()}};var e=function(n){var o=jQuery("div.wrapper ul",a);var p=jQuery("udata",n).attr("folder")+"/";o.html("");jQuery("file",n).each(function(){g(jQuery(this),p,o)});jQuery("div.wrapper img",a).mouseenter(function(){if(h!==0){return}var s=jQuery("div.del",a);var q=jQuery(this).offset();var t=q.left+43;if(t<s.parent().width()){s.css({left:t});if(jQuery.browser.msie&&(jQuery.browser.version=="7.0"||document.documentMode<8)){var r=q.left+23;if(jQuery.browser.version=="7.0"||document.documentMode<7){var u=Math.abs(o.offset().left-57);r=r+u}s.css({left:r,top:0})}s.get(0).panelItem=jQuery(this).parent();s.show()}}).mouseleave(function(){jQuery("div.del",a).hide()}).draggable({helper:"clone",revert:"invalid"}).disableSelection();jQuery("iframe",f.getContainer()).droppable({accept:"#"+f.getContainer().id+" div.wrapper img",drop:function(q,r){f.windowManager.open({file:f.plugins.imagemanager.url+"/sizedialog.htm",width:400,height:201,inline:1},r.draggable[0].information)}})};this.toggle=function(){if(!a){k()}d=!d;jQuery(a).slideToggle(0);return d};c()}function ImageManagerPath(p){var b=p.container||null;var m=p.selectCallback||null;var j=null;var h=null;var k=[];var o=[];var a={};var c=function(){h=document.createElement("ul");h.className="subfoldersMenu";h.style.display="none";document.body.appendChild(h);j=document.createElement("ul");j.className="insets";b.appendChild(j);var r;if(mce_lang="en"){r="Images"}else{if(mce_lang="ru"){r="Изображения"}}var q=n(r,"images");j.appendChild(q)};var n=function(r,q){var s=jQuery('<li><a href="javascript:void(0);">'+r+"</a><span /></li>");if(!k.length){s.addClass("first")}k.push(s);o.push(q||r);jQuery("a",s).click(function(){f(s);m("/"+o.join("/"))});jQuery("span",s).click(function(u){u.stopPropagation();if(!jQuery(this).hasClass("active")||jQuery(h).css("display")=="none"){var t=e(s);jQuery("span.active",j).removeClass("active");jQuery(this).addClass("active");i(t,s)}else{l();jQuery(this).removeClass("active")}});return s.get(0)};var i=function(u,q){if(a[u] instanceof Array){var r=jQuery("span",q);if(!a[u].length){r.hide();return}var v=r.offset();var t=v.top+r.height();var s=v.left;jQuery(h).html(jQuery.map(a[u],function(w){return"<li>"+w+"</li>"}).join(""));d();jQuery(h).css({position:"absolute","z-index":1000,top:t+"px",left:s+"px"});jQuery("li",h).click(function(y){f(q);var w=jQuery(this);var x=n(w.text());j.appendChild(x);l();r.removeClass("active");m("/"+o.join("/"));y.stopPropagation()});jQuery("li",h).mouseenter(function(){jQuery(this).addClass("highlighted")});jQuery("li",h).mouseleave(function(){jQuery(this).removeClass("highlighted")})}else{jQuery.get("/admin/data/getfolderlist/",{folder:base64encode(u)},function(y){var x=jQuery("folder",y);a[u]=[];for(var w=0;w<x.length;w++){a[u].push(jQuery(x[w]).attr("name"))}i(u,q)})}};var f=function(q){while(k.length&&k[k.length-1]!=q){k.pop().remove();o.pop()}};var e=function(r){var q=jQuery.inArray(r,k);if(q!=-1){return"/"+o.slice(0,q+1).join("/")}else{return"/"+o.join("/")}};var d=function(){jQuery(h).css("display","block");jQuery(document).bind("click",g)};var l=function(){jQuery(h).css("display","none");jQuery(document).unbind("click",g)};var g=function(){jQuery("span.active",j).removeClass("active");l()};this.getPath=function(){return"/"+o.join("/")};c()};